{% extends "homepage/base.html" %}

{% block content %}
<div id="js-messages"></div>

<div class="row mb-4 align-items-center">
    <div class="col-md-6">
        <h2 class="text-secondary">
            <a href="{% url 'dashboard' %}" class="text-secondary"><i class="fas fa-arrow-left"></i></a>
            Brother Directory
        </h2>
    </div>

    <div class="col-md-6 text-right">
        <button type="button" class="btn btn-outline-dark shadow-sm mr-1" onclick="sendMassEmail()">
            <i class="fas fa-envelope"></i> Mass Email
        </button>

        {% if user.position.can_manage_points %}
        <button type="submit" form="bulk-actions-form" formaction="{% url 'manage_points_creation' %}"
            class="btn btn-primary shadow-sm mr-1">
            <i class="fas fa-star"></i> Points
        </button>
        {% endif %}

        {% if user.position.can_manage_finance %}
        <button type="submit" form="bulk-actions-form" formaction="{% url 'manage_dues_creation' %}"
            class="btn btn-success shadow-sm">
            <i class="fas fa-file-invoice-dollar"></i> Bill
        </button>
        {% endif %}
    </div>
</div>

<div class="row mb-4">
    <div class="col-md-12">
        <div class="card shadow-sm p-3">
            <form method="GET" class="form-inline justify-content-center">

                <div class="input-group mb-2 mr-sm-2" style="width: 50%;">
                    <div class="input-group-prepend">
                        <div class="input-group-text"><i class="fas fa-search"></i></div>
                    </div>
                    <input type="text" name="q" class="form-control" placeholder="Search name, major, or hometown..."
                        value="{{ search_query }}">
                </div>

                <select name="status" class="custom-select mb-2 mr-sm-2">
                    <option value="">All Statuses</option>
                    <option value="ACT">Actives</option>
                    <option value="NM">New Members</option>
                </select>

                <button type="submit" class="btn btn-primary mb-2">Filter</button>

                {% if search_query or request.GET.status %}
                <a href="{% url 'brother_directory' %}" class="btn btn-outline-secondary mb-2 ml-2">Clear</a>
                {% endif %}
            </form>
        </div>
    </div>
</div>

<form id="bulk-actions-form" method="POST" action="{% url 'manage_dues_creation' %}">
    {% csrf_token %}
    <input type="hidden" name="directory_selection" value="1">

    <div class="row">
        {% for member in members %}
        <div class="col-lg-3 col-md-4 col-sm-6 mb-4">
            <div class="card h-100 shadow-sm border-0 hover-card position-relative">

                <div style="position: absolute; top: 10px; left: 10px; z-index: 10;">
                    <input type="checkbox" name="selected_members" value="{{ member.id }}"
                        data-email="{{ member.email }}" class="big-checkbox member-checkbox"
                        style="transform: scale(1.5);">
                </div>

                <a href="{% url 'brother_profile' member.pk %}" class="stretched-link"></a>

                <div class="text-center pt-4">
                    <img src="{{ member.image.url }}" class="rounded-circle img-thumbnail"
                        style="width: 120px; height: 120px; object-fit: cover;">
                </div>

                <div class="card-body text-center">

                    <h5 class="card-title font-weight-bold mb-1">
                        {{ member.first_name }} {{ member.last_name }}
                    </h5>

                    <span class="badge badge-pill 
                    {% if member.status == 'NM' %}badge-info
                    {% elif member.status == 'ACT' %}badge-dark
                    {% else %}badge-primary{% endif %} mb-2">
                        {{ member.get_status_display }}
                    </span>

                    <p class="card-text text-muted small mb-1">
                        <i class="fas fa-graduation-cap"></i> {{ member.position.title|default:"No Position" }}
                    </p>
                </div>

                <div class="card-footer bg-white border-top-0 pb-4 px-4">
                    <a href="mailto:{{ member.email }}" class="btn btn-outline-primary btn-block"
                        style="position: relative; z-index: 2;">
                        <i class="fas fa-envelope"></i> Email
                    </a>
                </div>
            </div>
        </div>
        {% empty %}
        <div class="col-12 text-center py-5">
            <h4 class="text-muted">No brothers found matching your search.</h4>
        </div>
        {% endfor %}
    </div>
</form>

<script>
    function showMessage(message, type) {
        const container = document.getElementById('js-messages');
        const alertId = 'alert-' + Date.now(); // Unique ID for this alert

        // Create the alert HTML
        const html = `
            <div id="${alertId}" class="alert alert-${type} alert-dismissible fade show shadow-sm" role="alert">
                <i class="fas ${type === 'success' ? 'fa-check-circle' : 'fa-exclamation-circle'}"></i> 
                ${message}
                <button type="button" class="close" data-dismiss="alert" aria-label="Close">
                    <span aria-hidden="true">&times;</span>
                </button>
            </div>
        `;

        container.innerHTML = html;
        window.scrollTo({ top: 0, behavior: 'smooth' });

        // Set Timer to remove it after 5 seconds (5000ms)
        setTimeout(() => {
            const element = document.getElementById(alertId);
            if (element) {
                $(element).alert('close');
            }
        }, 5000);
    }

    function sendMassEmail() {
        // Find all checked boxes
        const checkboxes = document.querySelectorAll('.member-checkbox:checked');

        if (checkboxes.length === 0) {
            alert("Please select at least one member to email.");
            return;
        }

        // Collect emails
        let emails = [];
        checkboxes.forEach((box) => {
            const email = box.getAttribute('data-email');
            if (email) emails.push(email);
        });

        if (emails.length === 0) {
            alert("None of the selected members have email addresses.");
            return;
        }

        const emailString = emails.join(', ');

        // Try to Copy to Clipboard
        navigator.clipboard.writeText(emailString).then(() => {
            showMessage("Email addresses copied to clipboard.", "success");

            // Try to open mail client
            setTimeout(() => {
                window.location.href = `mailto:?bcc=${emails.join(',')}`;
            }, 1000);

        }).catch(err => {
            // FAILURE: Show Red Alert
            console.error('Failed to copy: ', err);
            showMessage("Could not copy emails automatically. Please check permissions.", "danger");
        });
    }
</script>

<style>
    .hover-card:hover {
        transform: translateY(-5px);
        transition: transform 0.2s;
    }
</style>
{% endblock %}