{% extends "homepage/base.html" %}

{% block content %}
<div class="row mb-4 align-items-center">
    <div class="col-md-6">
        <a href="{% url 'dashboard' %}" class="text-secondary small">
            <i class="fas fa-arrow-left"></i> Back to Dashboard
        </a>
        <h2 class="text-secondary font-weight-bold mt-1">Points Hub</h2>
    </div>
    <div class="col-md-6 text-md-right mt-3 mt-md-0">
        <a href="{% url 'submit_points' %}" class="btn btn-primary shadow-sm mr-2">
            <i class="fas fa-plus-circle"></i> Request Points
        </a>
        {% if user.status != 'NM' %}
        <a href="{% url 'assign_points' %}" class="btn btn-dark shadow-sm">
            <i class="fas fa-bolt"></i> Direct Assign
        </a>
        {% endif %}
    </div>
</div>

<div class="row mb-5">
    <div class="col-12 mb-3">
        <h4 class="border-bottom pb-2">üèÜ Leaderboards</h4>
    </div>

    {% if user.status != 'NM' %}
    <div class="col-md-6 mb-4">
        {% else %}
        <div class="col-md-12 mb-4">
            {% endif %}
            <div class="card shadow-sm border-info h-100">
                <div class="card-header bg-info text-white d-flex justify-content-between align-items-center">
                    <h6 class="mb-0">üê£ New Members</h6>
                    {% if user.status == 'NM' %}
                    <span class="badge badge-light font-weight-bold">Your Score: {{ total_points }}</span>
                    {% endif %}
                </div>
                <ul class="list-group list-group-flush" style="max-height: 400px; overflow-y: auto;">
                    {% for entry in nm_leaderboard %}
                    <li
                        class="list-group-item d-flex justify-content-between align-items-center {% if entry == user %}bg-warning text-dark border-warning font-weight-bold{% endif %}">
                        <span>
                            <span class="badge badge-light badge-pill mr-2 border">#{{ forloop.counter }}</span>
                            {{ entry.first_name }} {{ entry.last_name }}
                        </span>
                        <span class="font-weight-bold">{{ entry.total_points_val }} pts</span>
                    </li>
                    {% empty %}
                    <li class="list-group-item text-muted text-center py-4">No points recorded yet.</li>
                    {% endfor %}
                </ul>
            </div>
        </div>

        {% if user.status != 'NM' %}
        <div class="col-md-6 mb-4">
            <div class="card shadow-sm border-dark h-100">
                <div class="card-header bg-dark text-white d-flex justify-content-between align-items-center">
                    <h6 class="mb-0">‚öîÔ∏è Actives & Execs</h6>
                    <span class="badge badge-light font-weight-bold">Your Score: {{ total_points }}</span>
                </div>
                <ul class="list-group list-group-flush" style="max-height: 400px; overflow-y: auto;">
                    {% for entry in active_leaderboard %}
                    <li
                        class="list-group-item d-flex justify-content-between align-items-center {% if entry == user %}bg-warning text-dark border-warning font-weight-bold{% endif %}">
                        <span>
                            <span class="badge badge-secondary badge-pill mr-2 border border-light">
                                #{{ forloop.counter }}
                            </span>
                            {{ entry.first_name }} {{ entry.last_name }}
                        </span>
                        <span class="font-weight-bold">{{ entry.total_points_val }} pts</span>
                    </li>
                    {% empty %}
                    <li class="list-group-item text-muted text-center py-4">No points recorded yet.</li>
                    {% endfor %}
                </ul>
            </div>
        </div>
        {% endif %}
    </div>

    {% if my_action_items or exec_queue %}
    <div class="row mb-5">
        <div class="col-12">
            <h4 class="border-bottom pb-2 text-danger">
                ‚ö†Ô∏è Inbox <span class="badge badge-danger align-middle ml-2"
                    style="font-size: 0.5em; vertical-align: middle;">ACTION REQUIRED</span>
            </h4>
            <div class="card shadow border-left-danger">
                <div class="list-group list-group-flush">
                    {% for point in my_action_items %}
                    {% include "dashboard/partials/point_row.html" with point=point queue_type="direct" %}
                    {% endfor %}

                    {% for point in exec_queue %}
                    {% include "dashboard/partials/point_row.html" with point=point queue_type="exec" %}
                    {% endfor %}
                </div>
            </div>
        </div>
    </div>
    {% endif %}

    <div class="row">
        <div class="col-12">
            <div class="d-flex justify-content-between align-items-center mb-2 border-bottom pb-2">
                <h4 class="mb-0">üìú Point Logs</h4>

                {% if current_recipient or current_approver %}
                <a href="?sort={{ current_sort }}" class="badge badge-secondary p-2">
                    <i class="fas fa-times"></i> Clear Filters
                </a>
                {% endif %}
            </div>

            <div class="card shadow-sm">
                {% if user.status != 'NM' %}
                <div class="card-header">
                    <ul class="nav nav-tabs card-header-tabs" id="logTabs" role="tablist">
                        <li class="nav-item">
                            <a class="nav-link active" id="nm-logs-tab" data-toggle="tab" href="#nmlogs" role="tab">
                                üê£ New Member Logs
                            </a>
                        </li>

                        <li class="nav-item">
                            <a class="nav-link" id="act-logs-tab" data-toggle="tab" href="#actlogs" role="tab">
                                ‚öîÔ∏è Active Logs
                            </a>
                        </li>

                    </ul>
                </div>
                {% endif %}

                <div class="card-body p-0">
                    <div class="tab-content" id="logTabsContent">

                        <div class="tab-pane fade show active" id="nmlogs" role="tabpanel">
                            <div class="table-responsive" style="overflow: visible;">
                                <table class="table table-striped table-sm mb-0 small">
                                    <thead class="thead-light">
                                        <tr>
                                            <th style="min-width: 150px;">
                                                <div class="dropdown">
                                                    <a class="text-dark font-weight-bold dropdown-toggle text-decoration-none"
                                                        href="#" role="button" data-toggle="dropdown"
                                                        aria-haspopup="true" aria-expanded="false"
                                                        data-boundary="viewport">
                                                        Recipient {% if current_recipient %}<i
                                                            class="fas fa-filter text-primary"></i>{% endif %}
                                                    </a>
                                                    <div class="dropdown-menu shadow"
                                                        style="max-height: 300px; overflow-y: auto;">
                                                        <a class="dropdown-item"
                                                            href="?recipient=&approver={{ current_approver }}&sort={{ current_sort }}">All</a>
                                                        <div class="dropdown-divider"></div>
                                                        {% for m in chapter_members %}<a class="dropdown-item"
                                                            href="?recipient={{ m.id }}&approver={{ current_approver }}&sort={{ current_sort }}">
                                                            {{ m.first_name }} {{ m.last_name }}</a>{% endfor %}
                                                    </div>
                                                </div>
                                            </th>
                                            <th style="min-width: 150px;">
                                                <div class="dropdown">
                                                    <a class="text-dark font-weight-bold dropdown-toggle text-decoration-none"
                                                        href="#" role="button" data-toggle="dropdown"
                                                        aria-haspopup="true" aria-expanded="false"
                                                        data-boundary="viewport">
                                                        Approver {% if current_approver %}<i
                                                            class="fas fa-filter text-primary"></i>{% endif %}
                                                    </a>
                                                    <div class="dropdown-menu shadow"
                                                        style="max-height: 300px; overflow-y: auto;">
                                                        <a class="dropdown-item"
                                                            href="?approver=&recipient={{ current_recipient }}&sort={{ current_sort }}">All</a>
                                                        <div class="dropdown-divider"></div>
                                                        {% for m in approvers_list %}<a class="dropdown-item"
                                                            href="?approver={{ m.id }}&recipient={{ current_recipient }}&sort={{ current_sort }}">
                                                            {{ m.first_name }} {{ m.last_name }}</a>{% endfor %}
                                                    </div>
                                                </div>
                                            </th>
                                            <th class="align-middle">Description</th>
                                            <th class="align-middle"><a
                                                    href="?sort={% if current_sort == 'amount' %}-amount{% else %}amount{% endif %}&recipient={{ current_recipient }}&approver={{ current_approver }}"
                                                    class="text-dark text-decoration-none font-weight-bold">Amount</a>
                                            </th>
                                            <th class="align-middle">Status</th>
                                            <th class="align-middle"><a
                                                    href="?sort={% if current_sort == 'date_submitted' %}-date_submitted{% else %}date_submitted{% endif %}&recipient={{ current_recipient }}&approver={{ current_approver }}"
                                                    class="text-dark text-decoration-none font-weight-bold">Date</a>
                                            </th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        {% for point in nm_logs %}
                                        <tr>
                                            <td>
                                                {% if point.user == user %}
                                                <span class="text-primary font-weight-bold">You</span>
                                                {% else %}
                                                {{ point.user.first_name }} {{ point.user.last_name }}
                                                {% endif %}
                                            </td>

                                            <td>
                                                {% if point.assigned_approver %}
                                                {% if point.assigned_approver == user %}
                                                <span class="text-primary font-weight-bold">You</span>
                                                {% else %}
                                                {{ point.assigned_approver.first_name }}
                                                {{ point.assigned_approver.last_name }}
                                                {% endif %}
                                                {% else %}
                                                <span class="text-muted">-</span>
                                                {% endif %}
                                            </td>
                                            <td>{{ point.description|truncatechars:35 }}</td>
                                            <td class="font-weight-bold">{{ point.amount }}</td>
                                            <td><span
                                                    class="{% if point.status == 'APPROVED' %}text-success{% elif point.status == 'REJECTED' %}text-danger{% else %}text-warning{% endif %}">
                                                    {{ point.get_status_display }}
                                                </span></td>
                                            <td>{{ point.date_submitted|date:"M d" }}</td>
                                        </tr>
                                        {% empty %}
                                        <tr>
                                            <td colspan="6" class="text-center text-muted py-4">No New Member records
                                                found.
                                            </td>
                                        </tr>
                                        {% endfor %}
                                    </tbody>
                                </table>
                            </div>
                        </div>

                        {% if user.status != 'NM' %}
                        <div class="tab-pane fade" id="actlogs" role="tabpanel">
                            <div class="table-responsive" style="overflow: visible;">
                                <table class="table table-striped table-sm mb-0 small">
                                    <thead class="thead-light">
                                        <tr>
                                            <th style="min-width: 150px;">
                                                <div class="dropdown">
                                                    <a class="text-dark font-weight-bold dropdown-toggle text-decoration-none"
                                                        href="#" role="button" data-toggle="dropdown"
                                                        aria-haspopup="true" aria-expanded="false"
                                                        data-boundary="viewport">
                                                        Recipient {% if current_recipient %}<i
                                                            class="fas fa-filter text-primary"></i>{% endif %}
                                                    </a>
                                                    <div class="dropdown-menu shadow"
                                                        style="max-height: 300px; overflow-y: auto;">
                                                        <a class="dropdown-item"
                                                            href="?recipient=&approver={{ current_approver }}&sort={{ current_sort }}">All</a>
                                                        <div class="dropdown-divider"></div>
                                                        {% for m in chapter_members %}<a class="dropdown-item"
                                                            href="?recipient={{ m.id }}&approver={{ current_approver }}&sort={{ current_sort }}">
                                                            {{ m.first_name }} {{ m.last_name }}</a>{% endfor %}
                                                    </div>
                                                </div>
                                            </th>
                                            <th style="min-width: 150px;">
                                                <div class="dropdown">
                                                    <a class="text-dark font-weight-bold dropdown-toggle text-decoration-none"
                                                        href="#" role="button" data-toggle="dropdown"
                                                        aria-haspopup="true" aria-expanded="false"
                                                        data-boundary="viewport">
                                                        Approver {% if current_approver %}<i
                                                            class="fas fa-filter text-primary"></i>{% endif %}
                                                    </a>
                                                    <div class="dropdown-menu shadow"
                                                        style="max-height: 300px; overflow-y: auto;">
                                                        <a class="dropdown-item"
                                                            href="?approver=&recipient={{ current_recipient }}&sort={{ current_sort }}">All</a>
                                                        <div class="dropdown-divider"></div>
                                                        {% for m in approvers_list %}<a class="dropdown-item"
                                                            href="?approver={{ m.id }}&recipient={{ current_recipient }}&sort={{ current_sort }}">
                                                            {{ m.first_name }} {{ m.last_name }}</a>{% endfor %}
                                                    </div>
                                                </div>
                                            </th>
                                            <th class="align-middle">Description</th>
                                            <th class="align-middle"><a
                                                    href="?sort={% if current_sort == 'amount' %}-amount{% else %}amount{% endif %}&recipient={{ current_recipient }}&approver={{ current_approver }}"
                                                    class="text-dark text-decoration-none font-weight-bold">Amount</a>
                                            </th>
                                            <th class="align-middle">Status</th>
                                            <th class="align-middle"><a
                                                    href="?sort={% if current_sort == 'date_submitted' %}-date_submitted{% else %}date_submitted{% endif %}&recipient={{ current_recipient }}&approver={{ current_approver }}"
                                                    class="text-dark text-decoration-none font-weight-bold">Date</a>
                                            </th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        {% for point in active_logs %}
                                        <tr>
                                            <td>
                                                {% if point.user == user %}
                                                <span class="text-primary font-weight-bold">You</span>
                                                {% else %}
                                                {{ point.user.first_name }} {{ point.user.last_name }}
                                                {% endif %}
                                            </td>

                                            <td>
                                                {% if point.assigned_approver %}
                                                {% if point.assigned_approver == user %}
                                                <span class="text-primary font-weight-bold">You</span>
                                                {% else %}
                                                {{ point.assigned_approver.first_name }}
                                                {{ point.assigned_approver.last_name }}
                                                {% endif %}
                                                {% else %}
                                                <span class="text-muted">-</span>
                                                {% endif %}
                                            </td>
                                            <td>{{ point.description|truncatechars:35 }}</td>
                                            <td class="font-weight-bold">{{ point.amount }}</td>
                                            <td><span
                                                    class="{% if point.status == 'APPROVED' %}\text-success{% elif point.status == 'REJECTED' %}text-danger{% else %}text-warning{% endif %}">
                                                    {{ point.get_status_display }}
                                                </span></td>
                                            <td>{{ point.date_submitted|date:"M d" }}</td>
                                        </tr>
                                        {% empty %}
                                        <tr>
                                            <td colspan="6" class="text-center text-muted py-4">No Active Member records
                                                found.</td>
                                        </tr>
                                        {% endfor %}
                                    </tbody>
                                </table>
                            </div>
                        </div>
                        {% endif %}

                    </div>
                </div>
            </div>

        </div>
    </div>
    {% endblock %}